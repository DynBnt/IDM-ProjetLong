<?xml version="1.0" encoding="UTF-8"?>
<description:Group
    xmi:version="2.0"
    xmlns:xmi="http://www.omg.org/XMI"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:description="http://www.eclipse.org/sirius/description/1.1.0"
    xmlns:description_1="http://www.eclipse.org/sirius/diagram/description/1.1.0"
    xmlns:style="http://www.eclipse.org/sirius/diagram/description/style/1.1.0"
    xmlns:tool="http://www.eclipse.org/sirius/diagram/description/tool/1.1.0"
    xmlns:tool_1="http://www.eclipse.org/sirius/description/tool/1.1.0"
    name="netlist"
    version="12.0.0.2017041100">

  <ownedViewpoints name="MyViewpoint" id="fr.n7.netlist.design.viewpoint">

    <!-- Métamodèles -->
    <metamodel href="http://www.example.org/netlist"/>
    <metamodel href="http://fr.n7.catalogue"/>

    <ownedRepresentations xsi:type="description_1:DiagramDescription"
        name="NetlistDiagram"
        label="NetlistDiagram"
        domainClass="netlist::Netlist"
        enablePopupBars="true">

      <defaultLayer name="Default">

        <!-- InstanceComposant -->
        <nodeMappings
            name="InstanceComposantNode"
            domainClass="netlist::InstanceComposant"
            semanticCandidatesExpression="aql:self.elements->filter(netlist::InstanceComposant)">

          <!-- Ports -->
          <borderedNodeMappings
              name="PortNode"
              domainClass="netlist::InstancePort"
              semanticCandidatesExpression="aql:self.ports">

            <style xsi:type="style:SquareDescription"
                labelSize="9"
                labelExpression="aql:self.port.nom"
                width="12"
                height="12">
              <borderColor xsi:type="description:SystemColor"
                  href="environment:/viewpoint#//@systemColors/@entries[name='black']"/>
              <labelColor xsi:type="description:SystemColor"
                  href="environment:/viewpoint#//@systemColors/@entries[name='black']"/>
              <color xsi:type="description:SystemColor"
                  href="environment:/viewpoint#//@systemColors/@entries[name='white']"/>
            </style>

          </borderedNodeMappings>

          <!-- Style InstanceComposant -->
          <style xsi:type="style:SquareDescription"
              labelSize="30"
              labelExpression="aql:self.nom + ' : ' + self.type.nom"
              resizeKind="NSEW"
              width="120"
              height="60">
            <borderColor xsi:type="description:SystemColor"
                href="environment:/viewpoint#//@systemColors/@entries[name='black']"/>
            <labelColor xsi:type="description:SystemColor"
                href="environment:/viewpoint#//@systemColors/@entries[name='black']"/>
            <color xsi:type="description:SystemColor"
                href="environment:/viewpoint#//@systemColors/@entries[name='light_gray']"/>
          </style>

        </nodeMappings>

        <!-- Connexions -->
        <edgeMappings
            name="ConnexionEdge"
            domainClass="netlist::Connexion"
            useDomainElement="true"
            semanticCandidatesExpression="aql:self.elements->filter(netlist::Connexion)"
            sourceMapping="//@ownedViewpoints[name='MyViewpoint']/@ownedRepresentations[name='NetlistDiagram']/@defaultLayer/@nodeMappings[name='InstanceComposantNode']/@borderedNodeMappings[name='PortNode']"
            targetMapping="//@ownedViewpoints[name='MyViewpoint']/@ownedRepresentations[name='NetlistDiagram']/@defaultLayer/@nodeMappings[name='InstanceComposantNode']/@borderedNodeMappings[name='PortNode']"
            sourceFinderExpression="aql:self.portDepart"
            targetFinderExpression="aql:self.portArrivee">

          <style sizeComputationExpression="2">
            <strokeColor xsi:type="description:SystemColor"
                href="environment:/viewpoint#//@systemColors/@entries[name='black']"/>
            <centerLabelStyleDescription
                labelSize="9"
                labelExpression="aql:self.nom">
              <labelColor xsi:type="description:SystemColor"
                  href="environment:/viewpoint#//@systemColors/@entries[name='black']"/>
            </centerLabelStyleDescription>
          </style>

        </edgeMappings>

        <!-- Tools -->
         <toolSections name="Tools">

          <!-- Create InstanceComposant -->
          <ownedTools xsi:type="tool:NodeCreationDescription"
              name="CreateInstanceComposant"
              label="Créer InstanceComposant"
              nodeMappings="//@ownedViewpoints[name='MyViewpoint']/@ownedRepresentations[name='NetlistDiagram']/@defaultLayer/@nodeMappings[name='InstanceComposantNode']">

            <variable name="container"/>
            <viewVariable name="containerView"/>

            <initialOperation>
              <firstModelOperations xsi:type="tool_1:ChangeContext"
                  browseExpression="aql:container">
                <subModelOperations xsi:type="tool_1:CreateInstance"
                    typeName="netlist.InstanceComposant"
                    referenceName="elements"
                    variableName="newInstance">
                  <subModelOperations xsi:type="tool_1:SetValue"
                      featureName="nom"
                      valueExpression="aql:'Composant' + (self.elements->filter(netlist::InstanceComposant)->size() + 1).toString()"/>
                </subModelOperations>
              </firstModelOperations>
            </initialOperation>

          </ownedTools>

          <!-- Create Connexion -->
          <ownedTools xsi:type="tool:EdgeCreationDescription"
              name="CreateConnexion"
              label="Créer Connexion"
              edgeMappings="//@ownedViewpoints.0/@ownedRepresentations.0/@defaultLayer/@edgeMappings[name='ConnexionEdge']"
              sourceMappings="//@ownedViewpoints.0/@ownedRepresentations.0/@defaultLayer/@nodeMappings.0/@borderedNodeMappings.0"
              targetMappings="//@ownedViewpoints.0/@ownedRepresentations.0/@defaultLayer/@nodeMappings.0/@borderedNodeMappings.0">

            <sourceVariable name="source"/>
            <targetVariable name="target"/>
            <sourceViewVariable name="sourceView"/>
            <targetViewVariable name="targetView"/>

            <initialOperation>
              <firstModelOperations xsi:type="tool_1:ChangeContext"
                  browseExpression="aql:source.eContainer().eContainer()">
                <subModelOperations xsi:type="tool_1:CreateInstance"
                    typeName="netlist.Connexion"
                    referenceName="elements"
                    variableName="newConn">
                  <subModelOperations xsi:type="tool_1:SetValue"
                      featureName="portDepart"
                      valueExpression="aql:source"/>
                  <subModelOperations xsi:type="tool_1:SetValue"
                      featureName="portArrivee"
                      valueExpression="aql:target"/>
                  <subModelOperations xsi:type="tool_1:SetValue"
                      featureName="depart"
                      valueExpression="aql:source.instance"/>
                  <subModelOperations xsi:type="tool_1:SetValue"
                      featureName="arrivee"
                      valueExpression="aql:target.instance"/>
                  <subModelOperations xsi:type="tool_1:SetValue"
                      featureName="nom"
                      valueExpression="aql:source.port.nom + '_to_' + target.port.nom"/>
                </subModelOperations>
              </firstModelOperations>
            </initialOperation>

          </ownedTools>


        </toolSections>


      </defaultLayer>

    </ownedRepresentations>

  </ownedViewpoints>

</description:Group>
